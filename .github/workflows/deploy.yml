- name: SSH Deploy to EC2
  uses: appleboy/ssh-action@v1.0.3
  with:
    host: ${{ secrets.EC2_HOST }}
    username: ${{ secrets.EC2_USER }}
    key: ${{ secrets.EC2_SSH_KEY }}
    script: |
      set -e
      OWNER_LC=$(echo "${{ env.OWNER }}" | tr '[:upper:]' '[:lower:]')
      IMAGE="ghcr.io/${OWNER_LC}/myapp:${{ github.sha }}"

      echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      
      # 기존 컨테이너 중지 및 제거
      docker rm -f spring-mes-api || true

      # 이미지 풀링
      docker pull "$IMAGE"

      # 컨테이너 실행
      docker run -d --name spring-mes-api --restart=always \
        --env-file /home/ubuntu/spring-mes-api/.env \
        -p 5999:5999 \
        "$IMAGE"

      # Health check
      for i in {1..30}; do
        curl -fsS http://127.0.0.1:5999/ && ok=1 && break || sleep 2
      done
      [ "$ok" = "1" ] || { echo "health failed"; docker logs spring-mes-api; exit 1; }
